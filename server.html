<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random P2P Chat</title>
</head>

<body>
    <button id="startChat">Start Chatting</button>
    <div id="chatArea" style="display: none;">
        <div id="messages"></div>
        <input type="text" id="messageInput">
        <button id="sendMessage">Send</button>
    </div>

    <script>
        const startChatButton = document.getElementById('startChat');
        const chatArea = document.getElementById('chatArea');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageButton = document.getElementById('sendMessage');

        let ws;
        let peerConnection;
        let dataChannel;

        startChatButton.addEventListener('click', startChat);
        sendMessageButton.addEventListener('click', sendMessage);

        function startChat() {
            ws = new WebSocket('ws://localhost:8080');

            ws.onopen = () => {
                ws.send(JSON.stringify({ type: 'join' }));
            };

            ws.onmessage = async (event) => {
                let message

                try {
                    message = JSON.parse(event.data);
                } catch (e) {
                    const data = new TextDecoder().decode(await event.data.arrayBuffer());
                    message = JSON.parse(data)
                }
                console.log(message)
                switch (message.type) {
                    case 'paired':
                        startChatButton.style.display = 'none';
                        chatArea.style.display = 'block';
                        initializePeerConnection(message.initiator);
                        break;
                    case 'offer':
                        await handleOffer(message);
                        break;
                    case 'answer':
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
                        break;
                    case 'ice-candidate':
                        await peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate));
                        break;
                    case 'disconnected':
                        displayMessage('Your chat partner disconnected.');
                        resetChat();
                        break;
                }

            };
        }

        function initializePeerConnection(isInitiator) {
            peerConnection = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'ice-candidate',
                        candidate: event.candidate
                    }));
                }
            };

            if (isInitiator) {
                dataChannel = peerConnection.createDataChannel('chat');
                setupDataChannel();

                peerConnection.createOffer()
                    .then(offer => peerConnection.setLocalDescription(offer))
                    .then(() => {
                        ws.send(JSON.stringify({
                            type: 'offer',
                            offer: peerConnection.localDescription
                        }));
                    });
            } else {
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel();
                };
            }
        }

        async function handleOffer(message) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            ws.send(JSON.stringify({
                type: 'answer',
                answer: peerConnection.localDescription
            }));
        }

        function setupDataChannel() {
            dataChannel.onopen = () => {
                displayMessage('Connected to chat partner.');
            };

            dataChannel.onmessage = (event) => {
                displayMessage(`Partner: ${event.data}`);
            };
        }

        function sendMessage() {
            const message = messageInput.value;
            if (message && dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(message);
                displayMessage(`You: ${message}`);
                messageInput.value = '';
            }
        }

        function displayMessage(message) {
            const messageElement = document.createElement('p');
            messageElement.textContent = message;
            messagesDiv.appendChild(messageElement);
        }

        function resetChat() {
            if (peerConnection) {
                peerConnection.close();
            }
            if (dataChannel) {
                dataChannel.close();
            }
            startChatButton.style.display = 'block';
            chatArea.style.display = 'none';
            messagesDiv.innerHTML = '';
        }
    </script>
</body>

</html>